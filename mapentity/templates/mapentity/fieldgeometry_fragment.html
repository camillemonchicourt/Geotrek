{% load leaflet_tags geojson_tags static mapentity %}
{% load url from future %}

{% leaflet_map module fitextent=False callback=callback %}

<div style="{% if not display_wkt %}display:none{% endif %}">
    {% include "floppyforms/textarea.html" %}
</div>

<script type="text/javascript">
// Lazy load : TODO : remove after refactor of formfield.js FormField
var FormField = window.FormField || {};
var MapEntity = window.MapEntity || {};

var {{ module }} = {{ module }} || {};

{% block settings %}

var {{ module }}_settings = {
    'enableDrawing': {
        'is_polygon': {{ is_polygone|yesno:"true,false" }},
        'is_marker': {{ is_point|yesno:"true,false" }},
        'is_polyline': {{ is_linestring|yesno:"true,false" }}
    },
    {% if path_snapping %}
    'enablePathSnapping': {
        'pathsLayer_url': "{% url 'core:path_layer' %}"
    },
    {% endif %}
    'addObjectsLayer': {
        'getUrl': function(modelname) {
            return '{% url 'core:path_layer' %}'.replace(new RegExp('path', 'g'), modelname);
        }
    },
    'init': {
        'enableDrawing': true,
        'objectBounds': {{ field|latlngbounds }},
        'pathsnapping': {{ path_snapping|yesno:"true,false" }},
        'layerStoreElemSelector': '#{{ attrs.id }}',
        'geojson': {{ field|geojsonfeature|safe }},  // If no field, will be null.
        'iconUrl': '{% static "mapentity/images/marker-trans.png" %}',
        'shadowUrl': '{% static "leaflet/images/marker-shadow.png" %}'
    },
};
{% endblock settings %}

// Django Leaflet callback
{{ callback }} = function (map, bounds) {
    {% smart_include "mapinit" %}

    var module = {{ module }};
    var fitToBounds = true;

    // We are displaying a form.
    // if no object instance, restore previous map view
    // Previous map view can come from list view, or from detail view
    if (!module.getObjectPk()) {
        if (MapEntity.Context.restoreLatestMapView(map, ['detail', 'list'])) {
            bounds = map.getBounds();
            // We just changed the map bounds, avoid resetting them...
            fitToBounds = false;
        }
    }
    module.init(map, bounds, fitToBounds);


    /* 
     * Allow to load files locally.
     */
    L.Control.FileLayerLoad.LABEL = '<i class="icon-folder-open"></i>';
    var pointToLayer = function (feature, latlng) {
            return L.circleMarker(latlng, {style: window.SETTINGS.map.styles.filelayer})
                    .setRadius(window.SETTINGS.map.styles.filelayer.radius);
        },
        onEachFeature = function (feature, layer) {
            if (feature.properties.name) {
                layer.bindLabel(feature.properties.name);
            }
        },
        filecontrol = L.Control.fileLayerLoad({
            fitBounds: true,
            layerOptions: {style: window.SETTINGS.map.styles.filelayer,
                           pointToLayer: pointToLayer,
                           onEachFeature: onEachFeature}
        });
    map.filecontrol = filecontrol;
    map.addControl(filecontrol);
};


$(document).ready(function (e) {
    FormField.makeModule({{ module }}, {{ module }}_settings);
});

</script>
